<!--
  -  Grouping of TA0005 "Defense Evasion" rules
  -  Author: Fabricio Brunetti
  -  Updated by Wazuh, Inc.
  -  Copyright (C) 2015-2021, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->




<group name="TA0005,">
    <!-- Sample: {"win":{"eventdata":{"originalFileName":"csc.exe","image":"C:\\\\Windows\\\\Microsoft.NET\\\\Framework64\\\\v4.0.30319\\\\csc.exe","product":"Microsoft® .NET Framework","parentProcessGuid":"{4dc16835-5bcf-6091-b801-000000003500}","description":"Visual C# Command Line Compiler","logonGuid":"{4dc16835-5948-6091-2f18-2d0000000000}","parentCommandLine":"powershell  -ExecutionPolicy Bypass -NoExit .\\\\meta.ps1","processGuid":"{4dc16835-5bd1-6091-b901-000000003500}","logonId":"0x2d182f","parentProcessId":"5912","processId":"5124","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\","utcTime":"2021-05-04 14:36:01.555","hashes":"SHA1=528973416456C780051889CA1709510B6BF73370,MD5=F65B029562077B648A6A5F6A1AA76A66,SHA256=4A6D0864E19C0368A47217C129B075DDDF61A6A262388F9D21045D82F3423ED7,IMPHASH=EE1E569AD02AA1F7AECA80AC0601D80D","parentImage":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","ruleName":"technique_id=T1127,technique_name=Trusted Developer Utilities Proxy Execution","company":"Microsoft Corporation","commandLine":"\\\"C:\\\\Windows\\\\Microsoft.NET\\\\Framework64\\\\v4.0.30319\\\\csc.exe\\\" /noconfig /fullpaths @\\\"C:\\\\Users\\\\AtomicRed\\\\AppData\\\\Local\\\\Temp\\\\bspmrlpb.cmdline\\\"","integrityLevel":"Medium","fileVersion":"4.8.4084.0 built by: NET48REL1","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1127,technique_name=Trusted Developer Utilities Proxy Execution\r\nUtcTime: 2021-05-04 14:36:01.555\r\nProcessGuid: {4dc16835-5bd1-6091-b901-000000003500}\r\nProcessId: 5124\r\nImage: C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe\r\nFileVersion: 4.8.4084.0 built by: NET48REL1\r\nDescription: Visual C# Command Line Compiler\r\nProduct: Microsoft® .NET Framework\r\nCompany: Microsoft Corporation\r\nOriginalFileName: csc.exe\r\nCommandLine: \"C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe\" /noconfig /fullpaths @\"C:\\Users\\AtomicRed\\AppData\\Local\\Temp\\bspmrlpb.cmdline\"\r\nCurrentDirectory: C:\\Users\\AtomicRed\\Downloads\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-5948-6091-2f18-2d0000000000}\r\nLogonId: 0x2D182F\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=528973416456C780051889CA1709510B6BF73370,MD5=F65B029562077B648A6A5F6A1AA76A66,SHA256=4A6D0864E19C0368A47217C129B075DDDF61A6A262388F9D21045D82F3423ED7,IMPHASH=EE1E569AD02AA1F7AECA80AC0601D80D\r\nParentProcessGuid: {4dc16835-5bcf-6091-b801-000000003500}\r\nParentProcessId: 5912\r\nParentImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nParentCommandLine: powershell  -ExecutionPolicy Bypass -NoExit .\\meta.ps1\"","version":"5","systemTime":"2021-05-04T14:36:01.5571724Z","eventRecordID":"168729","threadID":"3100","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2432","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92050" level="6">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.image" type="pcre2">(?i)\\csc\.exe</field>
        <field name="win.eventdata.parentCommandLine" type="pcre2">(?i)powershell.+ExecutionPolicy\s+bypass</field>
        <description>Powershell script compiling code using CSC.exe, possible malware drop</description>
        <mitre>
            <id>T1027.004</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"subjectLogonId":"0x3e7","restrictedAdminMode":"%%1843","subjectDomainName":"EXCHANGETEST","targetLinkedLogonId":"0x0","impersonationLevel":"%%1833","ipAddress":"192.168.0.1","authenticationPackageName":"Negotiate","workstationName":"BANKDC","targetLogonId":"0x4105aff","logonProcessName":"User32","logonGuid":"{64C35E00-1827-0FCE-2AE0-11E54FFE301F}","targetUserName":"Administrator","keyLength":"0","elevatedToken":"%%1842","subjectUserSid":"S-1-5-18","processId":"0x464","processName":"C:\\\\Windows\\\\System32\\\\svchost.exe","ipPort":"0","targetDomainName":"EXCHANGETEST","targetUserSid":"S-1-5-21-887924094-598891991-956377308-500","virtualAccount":"%%1843","logonType":"10","subjectUserName":"BANKDC$"},"system":{"eventID":"4624","keywords":"0x8020000000000000","providerGuid":"{54849625-5478-4994-A5BA-3E3B0328C30D}","level":"0","channel":"Security","opcode":"0","message":"\"An account was successfully logged on.\r\n\r\nSubject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tBANKDC$\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x3E7\r\n\r\nLogon Information:\r\n\tLogon Type:\t\t10\r\n\tRestricted Admin Mode:\tNo\r\n\tVirtual Account:\t\tNo\r\n\tElevated Token:\t\tYes\r\n\r\nImpersonation Level:\t\tImpersonation\r\n\r\nNew Logon:\r\n\tSecurity ID:\t\tS-1-5-21-887924094-598891991-956377308-500\r\n\tAccount Name:\t\tAdministrator\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x4105AFF\r\n\tLinked Logon ID:\t\t0x0\r\n\tNetwork Account Name:\t-\r\n\tNetwork Account Domain:\t-\r\n\tLogon GUID:\t\t{64C35E00-1827-0FCE-2AE0-11E54FFE301F}\r\n\r\nProcess Information:\r\n\tProcess ID:\t\t0x464\r\n\tProcess Name:\t\tC:\\Windows\\System32\\svchost.exe\r\n\r\nNetwork Information:\r\n\tWorkstation Name:\tBANKDC\r\n\tSource Network Address:\t::1\r\n\tSource Port:\t\t0\r\n\r\nDetailed Authentication Information:\r\n\tLogon Process:\t\tUser32 \r\n\tAuthentication Package:\tNegotiate\r\n\tTransited Services:\t-\r\n\tPackage Name (NTLM only):\t-\r\n\tKey Length:\t\t0\r\n\r\nThis event is generated when a logon session is created. It is generated on the computer that was accessed.\r\n\r\nThe subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.\r\n\r\nThe logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).\r\n\r\nThe New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.\r\n\r\nThe network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.\r\n\r\nThe impersonation level field indicates the extent to which a process in the logon session can impersonate.\r\n\r\nThe authentication information fields provide detailed information about this specific logon request.\r\n\t- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.\r\n\t- Transited services indicate which intermediate services have participated in this logon request.\r\n\t- Package name indicates which sub-protocol was used among the NTLM protocols.\r\n\t- Key length indicates the length of the generated session key. This will be 0 if no session key was requested.\"","version":"2","systemTime":"2021-07-02T20:19:32.631853500Z","eventRecordID":"4200219","threadID":"720","computer":"bankdc.ExchangeTest.com","task":"12544","processID":"556","severityValue":"AUDIT_SUCCESS","providerName":"Microsoft-Windows-Security-Auditing"}}} -->
    <rule id="92051" level="0">
        <if_sid>60106</if_sid>
        <field name="win.eventdata.logonType" type="pcre2">10</field>
        <description>User: $(win.eventdata.subjectDomainName)\$(win.eventdata.targetUserName) logged using Remote Desktop Connection (RDP) from ip:$(win.eventdata.ipAddress)</description>
        <mitre>
            <id>T1021.001</id>
            <id>T1078.002</id>
        </mitre>
    </rule>


    <!-- Sample: {"win":{"eventdata":{"subjectLogonId":"0x3e7","restrictedAdminMode":"%%1843","subjectDomainName":"EXCHANGETEST","targetLinkedLogonId":"0x0","impersonationLevel":"%%1833","ipAddress":"::1","authenticationPackageName":"Negotiate","workstationName":"BANKDC","targetLogonId":"0x4105aff","logonProcessName":"User32","logonGuid":"{64C35E00-1827-0FCE-2AE0-11E54FFE301F}","targetUserName":"Administrator","keyLength":"0","elevatedToken":"%%1842","subjectUserSid":"S-1-5-18","processId":"0x464","processName":"C:\\\\Windows\\\\System32\\\\svchost.exe","ipPort":"0","targetDomainName":"EXCHANGETEST","targetUserSid":"S-1-5-21-887924094-598891991-956377308-500","virtualAccount":"%%1843","logonType":"10","subjectUserName":"BANKDC$"},"system":{"eventID":"4624","keywords":"0x8020000000000000","providerGuid":"{54849625-5478-4994-A5BA-3E3B0328C30D}","level":"0","channel":"Security","opcode":"0","message":"\"An account was successfully logged on.\r\n\r\nSubject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tBANKDC$\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x3E7\r\n\r\nLogon Information:\r\n\tLogon Type:\t\t10\r\n\tRestricted Admin Mode:\tNo\r\n\tVirtual Account:\t\tNo\r\n\tElevated Token:\t\tYes\r\n\r\nImpersonation Level:\t\tImpersonation\r\n\r\nNew Logon:\r\n\tSecurity ID:\t\tS-1-5-21-887924094-598891991-956377308-500\r\n\tAccount Name:\t\tAdministrator\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x4105AFF\r\n\tLinked Logon ID:\t\t0x0\r\n\tNetwork Account Name:\t-\r\n\tNetwork Account Domain:\t-\r\n\tLogon GUID:\t\t{64C35E00-1827-0FCE-2AE0-11E54FFE301F}\r\n\r\nProcess Information:\r\n\tProcess ID:\t\t0x464\r\n\tProcess Name:\t\tC:\\Windows\\System32\\svchost.exe\r\n\r\nNetwork Information:\r\n\tWorkstation Name:\tBANKDC\r\n\tSource Network Address:\t::1\r\n\tSource Port:\t\t0\r\n\r\nDetailed Authentication Information:\r\n\tLogon Process:\t\tUser32 \r\n\tAuthentication Package:\tNegotiate\r\n\tTransited Services:\t-\r\n\tPackage Name (NTLM only):\t-\r\n\tKey Length:\t\t0\r\n\r\nThis event is generated when a logon session is created. It is generated on the computer that was accessed.\r\n\r\nThe subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.\r\n\r\nThe logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).\r\n\r\nThe New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.\r\n\r\nThe network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.\r\n\r\nThe impersonation level field indicates the extent to which a process in the logon session can impersonate.\r\n\r\nThe authentication information fields provide detailed information about this specific logon request.\r\n\t- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.\r\n\t- Transited services indicate which intermediate services have participated in this logon request.\r\n\t- Package name indicates which sub-protocol was used among the NTLM protocols.\r\n\t- Key length indicates the length of the generated session key. This will be 0 if no session key was requested.\"","version":"2","systemTime":"2021-07-02T20:19:32.631853500Z","eventRecordID":"4200219","threadID":"720","computer":"bankdc.ExchangeTest.com","task":"12544","processID":"556","severityValue":"AUDIT_SUCCESS","providerName":"Microsoft-Windows-Security-Auditing"}}} -->
    <rule id="92052" level="15">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.ipAddress" type="pcre2">::1|127\.0\.0\.1</field>
        <description>User: $(win.eventdata.subjectDomainName)\$(win.eventdata.targetUserName) logged using Remote Desktop Connection (RDP) from loopback address, possible exploit over reverse tunneling using stolen credentials</description>
        <mitre>
            <id>T1021.001</id>
            <id>T1078.002</id>
        </mitre>
    </rule>
</group>