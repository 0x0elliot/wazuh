<!--
  -  OracleDB 12C decoder
  -  Created by Wazuh, Inc.
  -  Copyright (C) 2015-2021, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->

<!--
  localfile implementation example:
  <localfile>
    <log_format>multi-line-regex</log_format>
    <location>/tmp/oracle/CDBTST111_j000_11111_11111111111111111111111111.aud</$
    <multiline_regex match="all">(?m)\n\n</multiline_regex>
    <out_format>$(timestamp) $(hostname) oracledb: $(log)</out_format>
  </localfile>
-->
<!--
Log example:
  Fri Jul 09 11:11:00 2021 +05:32
  LENGTH : '563'
  ACTION :[412] 'select /*+  no_parallel(t) no_parallel_index(t) dbms_stats cursor_sharing_exact use_weak_name_resl dynamic_sampling(0) no_monitoring xmlindex_sel_idx_tbl no_substrb_pad  */ substrb(dump("INSTANCE_NUMBER",16,0,64),1,240) val, 
                        rowidtochar(rowid) rwid from "SYS"."WRH$_SEG_STAT" t where rowid in (chartorowid('AAAAAAAAAAAAAAAAAA'),chartorowid('AAAAAAAAAAAAAAAAAA')) order by "INSTANCE_NUMBER"'
  DATABASE USER:[3] 'SYS'
  PRIVILEGE :[4] 'NONE'
  CLIENT USER:[0] ''
  CLIENT TERMINAL:[7] 'UNKNOWN'
  STATUS:[1] '0'
  DBID:[10] '3320902093'
-->

<decoder name="oracledb_log">
    <program_name>^oracledb$</program_name>
</decoder>

<decoder name="oracledb_transaction_fields">
    <parent>oracledb_log</parent>
    <regex>(?Ums)^LENGTH : '(\d+)'\n</regex>
    <regex>^ACTION :\[\d+] '(.+)'\n</regex>
    <regex>^DATABASE USER:\[\d+] '(.+)'\n</regex>
    <regex>^PRIVILEGE :\[\d+] '(.+)'\n</regex>
    <regex>^CLIENT USER:\[\d+] '(.*)'\n</regex>
    <regex>^CLIENT TERMINAL:\[\d+] '(.*)'\n</regex>
    <regex>^STATUS:\[\d+] '(.*)'\n</regex>
    <regex type="pcre2">^DBID:\[\d+] '(.*)'</regex>
    <order>length, action, database_user, privilege, client_user, client_terminal, status, database_id</order>
</decoder>

<!-- Parent decoder for oracledb .log files -->
<decoder name="oracledb-log-decoder">
    <prematch type="pcre2">ORA-\d+</prematch>
</decoder>

<!-- Timestamp -->
<decoder name="oracledb-log-decoder-fields">
    <parent>oracledb-log-decoder</parent>
    <regex type="pcre2">(\w{3}\s\w{3}\s\d{2}\s\d{2}:\d{2}:\d{2}\s\d{4})</regex>
    <order>timestamp</order>
</decoder>

<!-- Ora numbers -->
<decoder name="oracledb-log-decoder-fields">
    <parent>oracledb-log-decoder</parent>
    <regex type="pcre2">(?:ORA-(\d+))+</regex>
    <order>ora.code1, ora.code2, ora.code3, ora.code4</order>
</decoder>