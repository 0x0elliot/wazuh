/*
 * Wazuh Vulnerability scanner - Database Feed Manager
 * Copyright (C) 2015, Wazuh Inc.
 * Oct 3, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#ifndef _UPDATE_CVE_DESCRIPTION_HPP
#define _UPDATE_CVE_DESCRIPTION_HPP

#include "chainOfResponsability.hpp"
#include "cve5_generated.h"
#include "eventContext.hpp"
#include "flatbuffers/flatbuffers.h"
#include "rocksDBWrapper.hpp"
#include "vulnerabilityDescription_generated.h"

constexpr auto DESCRIPTION_DATABASE_PATH {"queue/vd/descriptions"};
constexpr auto CVE5_DATABASE_PATH {"queue/vd/cve5"};

/**
 * @brief UpdateCVEDescription class.
 *
 */
class UpdateCVEDescription final
{
public:
    /**
     * @brief Reads CVE5 database, creates a vulnerability description flatbuffer and stores it in a specific RocksDB
     * database.
     *
     * @param cve5Flatbuffer CVE5 Flatbuffer.
     * @param rocksDBWrapper rocksDB wrapper instance.
     */
    static void storeVulnerabilityDescription(const cve_v5::Entry* cve5Flatbuffer,
                                              Utils::RocksDBWrapper& rocksDBWrapper)
    {
        if (cve5Flatbuffer->containers() && cve5Flatbuffer->containers()->cna())
        {
            auto cna = cve5Flatbuffer->containers()->cna();
            // Missing metrics object is valid in a CVE5 schema.
            auto metricsArray = cna->metrics();
            auto descriptionArray = cna->descriptions();
            auto referencesArray = cna->references();
            auto problemTypesArray = cna->problemTypes();
            auto cve5Metadata = cve5Flatbuffer->cveMetadata();

            float vulnDescFBScoreBase = 0.0;
            std::string vulnDescFBClassificationStr;
            std::string vulnDescFBDescriptionStr;
            std::string vulnDescFBSeverityStr;
            std::string vulnDescFBScoreVersionStr;
            std::string vulnDescFBReferenceStr;
            std::string vulnDescFBAssignerStr;
            std::string vulnDescFBCWEIdStr;
            std::string vulnDescFBDataPublishedStr;
            std::string vulnDescFBDataUpdatedStr;
            std::string vulnDescFBAccessComplexityStr;
            std::string vulnDescFBAttackVectorStr;
            std::string vulnDescFBAuthenticationStr;
            std::string vulnDescFBAvailabilityStr;
            std::string vulnDescFBConfidentialityImpactStr;
            std::string vulnDescFBIntegrityImpactStr;
            std::string vulnDescFBPrivilegesRequiredStr;
            std::string vulnDescFBScopeStr;
            std::string vulnDescFBUserInteractionStr;

            if (descriptionArray)
            {
                for (const auto& field : *descriptionArray)
                {
                    if (field->lang()->str().compare("en") == 0)
                    {
                        vulnDescFBDescriptionStr = field->value()->str();
                        break;
                    }
                }
            }

            if (referencesArray)
            {
                for (const auto& field : *referencesArray)
                {
                    if (field->url())
                    {
                        vulnDescFBReferenceStr += field->url()->str();
                        vulnDescFBReferenceStr += ", ";
                    }
                }
            }

            vulnDescFBReferenceStr = vulnDescFBReferenceStr.substr(0, vulnDescFBReferenceStr.size() - 2);

            // Empty description or empty URL reference are not CVE5 Compliant.
            if (!(vulnDescFBDescriptionStr.empty() || vulnDescFBReferenceStr.empty()))
            {
                flatbuffers::FlatBufferBuilder builder;

                if (metricsArray)
                {
                    for (const auto& field : *metricsArray)
                    {
                        auto metricCVSSV3_1 = field->cvssV3_1();
                        auto metricCVSSV3_0 = field->cvssV3_0();
                        auto metricCVSSV2_0 = field->cvssV2_0();
                        if (metricCVSSV3_1)
                        {
                            vulnDescFBScoreBase = metricCVSSV3_1->baseScore();
                            auto baseSeverity = metricCVSSV3_1->baseSeverity();
                            vulnDescFBSeverityStr = (nullptr != baseSeverity) ? baseSeverity->str() : "";
                            auto version = metricCVSSV3_1->version();
                            vulnDescFBScoreVersionStr = (nullptr != version) ? version->str() : "";
                            auto format = field->format();
                            vulnDescFBClassificationStr = (nullptr != format) ? format->str() : "";
                            auto availability = metricCVSSV3_1->availabilityImpact();
                            vulnDescFBAvailabilityStr = (nullptr != availability) ? availability->str() : "";
                            auto confidentialityImpact = metricCVSSV3_1->confidentialityImpact();
                            vulnDescFBConfidentialityImpactStr =
                                (nullptr != confidentialityImpact) ? confidentialityImpact->str() : "";
                            auto integrityImpact = metricCVSSV3_1->integrityImpact();
                            vulnDescFBIntegrityImpactStr = (nullptr != integrityImpact) ? integrityImpact->str() : "";
                            auto privilegesRequired = metricCVSSV3_1->privilegesRequired();
                            vulnDescFBPrivilegesRequiredStr =
                                (nullptr != privilegesRequired) ? privilegesRequired->str() : "";
                            auto scope = metricCVSSV3_1->scope();
                            vulnDescFBScopeStr = (nullptr != scope) ? scope->str() : "";
                            auto userInteraction = metricCVSSV3_1->userInteraction();
                            vulnDescFBUserInteractionStr = (nullptr != userInteraction) ? userInteraction->str() : "";
                            break;
                        }
                        else if (metricCVSSV3_0)
                        {
                            vulnDescFBScoreBase = metricCVSSV3_0->baseScore();
                            auto baseSeverity = metricCVSSV3_0->baseSeverity();
                            vulnDescFBSeverityStr = (nullptr != baseSeverity) ? baseSeverity->str() : "";
                            auto version = metricCVSSV3_0->version();
                            vulnDescFBScoreVersionStr = (nullptr != version) ? version->str() : "";
                            auto format = field->format();
                            vulnDescFBClassificationStr = (nullptr != format) ? format->str() : "";
                            auto attackVector = metricCVSSV3_0->attackVector();
                            vulnDescFBAttackVectorStr = (nullptr != attackVector) ? attackVector->str() : "";
                            auto availability = metricCVSSV3_0->availabilityImpact();
                            vulnDescFBAvailabilityStr = (nullptr != availability) ? availability->str() : "";
                            auto confidentialityImpact = metricCVSSV3_0->confidentialityImpact();
                            vulnDescFBConfidentialityImpactStr =
                                (nullptr != confidentialityImpact) ? confidentialityImpact->str() : "";
                            auto integrityImpact = metricCVSSV3_0->integrityImpact();
                            vulnDescFBIntegrityImpactStr = (nullptr != integrityImpact) ? integrityImpact->str() : "";
                            auto privilegesRequired = metricCVSSV3_0->privilegesRequired();
                            vulnDescFBPrivilegesRequiredStr =
                                (nullptr != privilegesRequired) ? privilegesRequired->str() : "";
                            auto scope = metricCVSSV3_0->scope();
                            vulnDescFBScopeStr = (nullptr != scope) ? scope->str() : "";
                            auto userInteraction = metricCVSSV3_0->userInteraction();
                            vulnDescFBUserInteractionStr = (nullptr != userInteraction) ? userInteraction->str() : "";
                            break;
                        }
                        else if (metricCVSSV2_0)
                        {
                            vulnDescFBScoreBase = metricCVSSV2_0->baseScore();
                            vulnDescFBSeverityStr = (vulnDescFBScoreBase < 4.0)   ? "LOW"
                                                    : (vulnDescFBScoreBase < 7.0) ? "MEDIUM"
                                                                                  : "HIGH";
                            auto version = metricCVSSV2_0->version();
                            vulnDescFBScoreVersionStr = (nullptr != version) ? version->str() : "";
                            auto format = field->format();
                            vulnDescFBClassificationStr = (nullptr != format) ? format->str() : "";
                            auto accessComplexity = metricCVSSV2_0->accessComplexity();
                            vulnDescFBAccessComplexityStr =
                                (nullptr != accessComplexity) ? accessComplexity->str() : "";
                            auto authentication = metricCVSSV2_0->authentication();
                            vulnDescFBAuthenticationStr = (nullptr != authentication) ? authentication->str() : "";
                            auto availability = metricCVSSV2_0->availabilityImpact();
                            vulnDescFBAvailabilityStr = (nullptr != availability) ? availability->str() : "";
                            auto confidentialityImpact = metricCVSSV2_0->confidentialityImpact();
                            vulnDescFBConfidentialityImpactStr =
                                (nullptr != confidentialityImpact) ? confidentialityImpact->str() : "";
                            auto integrityImpact = metricCVSSV2_0->integrityImpact();
                            vulnDescFBIntegrityImpactStr = (nullptr != integrityImpact) ? integrityImpact->str() : "";
                            break;
                        }
                    }
                }

                if (cve5Metadata)
                {
                    auto assigner = cve5Metadata->assignerShortName();
                    vulnDescFBAssignerStr = (nullptr != assigner) ? assigner->str() : "";
                    auto published = cve5Metadata->datePublished();
                    vulnDescFBDataPublishedStr = (nullptr != published) ? published->str() : "";
                    auto updated = cve5Metadata->dateUpdated();
                    vulnDescFBDataUpdatedStr = (nullptr != updated) ? updated->str() : "";
                }

                if (problemTypesArray)
                {
                    auto problemTypesDescriptionsArray = problemTypesArray->Get(0);
                    if (problemTypesDescriptionsArray)
                    {
                        auto descriptionsProblemTypesArray = problemTypesDescriptionsArray->descriptions();
                        if (descriptionsProblemTypesArray)
                        {
                            auto cweId = descriptionsProblemTypesArray->Get(0)->cweId();
                            vulnDescFBCWEIdStr = (nullptr != cweId) ? cweId->str() : "";
                        }
                    }
                }

                auto vulnerabilityDescriptionFB = NSVulnerabilityScanner::CreateVulnerabilityDescriptionDirect(
                    builder,
                    vulnDescFBAccessComplexityStr.c_str(),
                    vulnDescFBAssignerStr.c_str(),
                    vulnDescFBAttackVectorStr.c_str(),
                    vulnDescFBAuthenticationStr.c_str(),
                    vulnDescFBAvailabilityStr.c_str(),
                    vulnDescFBClassificationStr.c_str(),
                    vulnDescFBConfidentialityImpactStr.c_str(),
                    vulnDescFBCWEIdStr.c_str(),
                    vulnDescFBDataPublishedStr.c_str(),
                    vulnDescFBDataUpdatedStr.c_str(),
                    vulnDescFBDescriptionStr.c_str(),
                    vulnDescFBIntegrityImpactStr.c_str(),
                    vulnDescFBPrivilegesRequiredStr.c_str(),
                    vulnDescFBReferenceStr.c_str(),
                    vulnDescFBScopeStr.c_str(),
                    vulnDescFBScoreBase,
                    vulnDescFBScoreVersionStr.c_str(),
                    vulnDescFBSeverityStr.c_str(),
                    vulnDescFBUserInteractionStr.c_str());

                builder.Finish(vulnerabilityDescriptionFB);

                const uint8_t* buffer = builder.GetBufferPointer();
                size_t flatbufferSize = builder.GetSize();

                std::string key {cve5Flatbuffer->cveMetadata()->cveId()->str()};
                const rocksdb::Slice VulnerabilityDescriptionSlice(reinterpret_cast<const char*>(buffer),
                                                                   flatbufferSize);
                rocksDBWrapper.put(key, VulnerabilityDescriptionSlice);
            }
        }
    }
};

#endif // _UPDATE_CVE_DESCRIPTION_HPP
