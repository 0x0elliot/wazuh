/*
 * Wazuh Vulnerability scanner - Scan Orchestrator
 * Copyright (C) 2015, Wazuh Inc.
 * Jun 1, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#ifndef _INVENTORY_SYNC_HPP
#define _INVENTORY_SYNC_HPP

#include "../policyManager/policyManager.hpp"
#include "chainOfResponsability.hpp"
#include "rocksDBWrapper.hpp"
#include "scanContext.hpp"

/**
 * @brief InventorySync class.
 *
 */
class InventorySync final : public AbstractHandler<std::shared_ptr<ScanContext>>
{
private:
    Utils::RocksDBWrapper& m_inventoryDatabase;

public:
    explicit InventorySync(Utils::RocksDBWrapper& inventoryDatabase)
        : m_inventoryDatabase(inventoryDatabase)
    {
    }

    /**
     * @brief Handles request and passes control to the next step of the chain.
     *
     * @param data Scan context.
     * @return std::shared_ptr<ScanContext> Abstract handler.
     */
    // LCOV_EXCL_START
    std::shared_ptr<ScanContext> handleRequest(std::shared_ptr<ScanContext> data) override
    {
        std::cout << "InventorySync::start" << std::endl;

        std::string agentPackageKey;
        agentPackageKey.append(data->agentNodeName());
        agentPackageKey.append("_");
        agentPackageKey.append(data->agentId());
        agentPackageKey.append("_");
        agentPackageKey.append(data->packageItemId());

        if (data->operationType() == OperationType::Delete)
        {
            std::string value;
            if (m_inventoryDatabase.get(agentPackageKey, value))
            {
                auto listCve = Utils::split(value, ',');
                for (const auto& cve : listCve)
                {
                    std::string elementKey;
                    nlohmann::json json;
                    elementKey.append(agentPackageKey);
                    elementKey.append("_");
                    elementKey.append(cve);
                    json["operation"] = "DELETED";
                    json["id"] = elementKey;
                    data->m_elements[elementKey] = json;
                }
                m_inventoryDatabase.delete_(agentPackageKey);
            }

            std::cout << "InventorySync::DELETE" << std::endl;
        }
        else if (data->operationType() == OperationType::Insert)
        {
            std::vector<std::string> insertList;
            std::string insertListString;
            std::string value;

            if (m_inventoryDatabase.get(agentPackageKey, value))
            {
                auto listCve = Utils::split(value, ',');
                for (auto& [key, value] : data->m_elements)
                {
                    if (std::find(listCve.begin(), listCve.end(), key) == listCve.end())
                    {
                        // Concatenate all cves to insert into the inventory.
                        insertListString.append(key);
                        insertListString.append(",");
                        std::cout << "InventorySync::INSERT" << std::endl;
                    }
                }

                if (!insertListString.empty())
                {
                    insertListString.append(value);
                    m_inventoryDatabase.put(agentPackageKey, insertListString);
                }
            }
            else
            {
                for (auto& [key, value] : data->m_elements)
                {
                    // Concatenate all cves to insert into the inventory.
                    insertListString.append(key);
                    insertListString.append(",");
                    std::cout << "InventorySync::INSERT" << std::endl;
                }

                if (!insertListString.empty())
                {
                    insertListString.pop_back();
                    m_inventoryDatabase.put(agentPackageKey, insertListString);
                }
            }
        }

        std::cout << "InventorySync::end" << std::endl;
        return AbstractHandler<std::shared_ptr<ScanContext>>::handleRequest(data);
    }
    // LCOV_EXCL_STOP
};

#endif // _INVENTORY_SYNC_HPP
