/*
 * Wazuh Vulnerability Scanner - Unit Tests
 * Copyright (C) 2015, Wazuh Inc.
 * February 21, 2024.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "buildAllAgentListContext_test.hpp"
#include "TrampolineOsDataCache.hpp"
#include "TrampolineRemediationDataCache.hpp"
#include "TrampolineSocketDBWrapper.hpp"
#include "buildAllAgentListContext.hpp"

using TrampolineScanContext = TScanContext<TrampolineOsDataCache, GlobalData, TrampolineRemediationDataCache>;

TEST_F(BuildAllAgentListContextTest, BuildAllAgentListContext)
{
    spSocketDBWrapperMock = std::make_shared<MockSocketDBWrapper>();
    EXPECT_CALL(*spSocketDBWrapperMock, query(testing::_, testing::_)).Times(1);

    auto allAgentContext = std::make_shared<
        TBuildAllAgentListContext<TScanContext<TrampolineOsDataCache, GlobalData, TrampolineRemediationDataCache>,
                                  TrampolineSocketDBWrapper>>();

    auto scanContext =
        std::make_shared<TScanContext<TrampolineOsDataCache, GlobalData, TrampolineRemediationDataCache>>();
    allAgentContext->handleRequest(scanContext);
}

TEST_F(BuildAllAgentListContextTest, BuildAllAgentListContextWithElements)
{
    static const std::string MESSAGE {
        R"(ok [{"id":1, "name":"name", "version": "Wazuh 4.4.4", "ip":"192.168.0.1","node_name":"node_1"}])"};

    spSocketDBWrapperMock = std::make_shared<MockSocketDBWrapper>();

    nlohmann::json queryResult = nlohmann::json::parse(R"([
        {
        "id": 1,
        "name": "name",
        "version": "Wazuh 4.4.4",
        "ip": "192.168.0.1",
        "node_name": "node_1"
        }
    ])");

    EXPECT_CALL(*spSocketDBWrapperMock, query(testing::_, testing::_))
        .Times(1)
        .WillOnce(testing::SetArgReferee<1>(queryResult));

    auto allAgentContext =
        std::make_shared<TBuildAllAgentListContext<TrampolineScanContext, TrampolineSocketDBWrapper>>();

    auto scanContext = std::make_shared<TrampolineScanContext>();

    // Context is not used
    allAgentContext->handleRequest(scanContext);

    EXPECT_EQ(scanContext->m_agents.size(), 1);
}

TEST_F(BuildAllAgentListContextTest, MissingField)
{
    static const std::string MESSAGE {
        R"(ok [{"name":"name", "version": "Wazuh 4.4.4", "ip":"192.168.0.1","node_name":"node_1"}])"};
    m_socketServer =
        std::make_shared<SocketServer<Socket<OSPrimitives, SizeHeaderProtocol>, EpollWrapper>>(TEST_SOCKET_PATH);

    m_socketServer->listen(
        [&](const int fd, const char* data, uint32_t size, const char* dataHeader, uint32_t sizeHeader)
        {
            std::ignore = dataHeader;
            std::ignore = sizeHeader;

            std::string receivedMsg(data, size);
            EXPECT_STREQ(receivedMsg.c_str(), EXPECTED_QUERY.c_str());

            m_socketServer->send(fd, MESSAGE.c_str(), MESSAGE.size());
        });

    auto allAgentContext = std::make_shared<
        TBuildAllAgentListContext<TScanContext<TrampolineOsDataCache, GlobalData, TrampolineRemediationDataCache>>>();

    auto scanContext =
        std::make_shared<TScanContext<TrampolineOsDataCache, GlobalData, TrampolineRemediationDataCache>>();

    allAgentContext->handleRequest(scanContext);
}

TEST_F(BuildAllAgentListContextTest, ExceptionOnDB)
{
    m_socketServer =
        std::make_shared<SocketServer<Socket<OSPrimitives, SizeHeaderProtocol>, EpollWrapper>>(TEST_SOCKET_PATH);

    m_socketServer->listen(
        [&](const int fd, const char* data, uint32_t size, const char* dataHeader, uint32_t sizeHeader)
        {
            std::ignore = dataHeader;
            std::ignore = sizeHeader;
            std::ignore = size;
            std::ignore = data;

            throw std::runtime_error("Error on DB");
        });

    remediationDataCache cache;
    std::string agentId {"1"};

    auto allAgentContext = std::make_shared<
        TBuildAllAgentListContext<TScanContext<TrampolineOsDataCache, GlobalData, TrampolineRemediationDataCache>>>();

    auto scanContext =
        std::make_shared<TScanContext<TrampolineOsDataCache, GlobalData, TrampolineRemediationDataCache>>();

    EXPECT_THROW(allAgentContext->handleRequest(scanContext), WdbDataException);
}
